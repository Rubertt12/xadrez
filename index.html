<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>War Engine v28.9 - Visual Status</title>
    <style>
        :root { --bg: #050508; --panel: #0d0d12; --accent: #00e5ff; --danger: #ff0055; --sq-l: #1e1e24; --sq-d: #0a0a0f; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { height: 100%; width: 100%; background: var(--bg); font-family: sans-serif; color: white; overflow: hidden; }

        /* CONFETTI */
        .confetti { position: absolute; width: 8px; height: 8px; z-index: 7000; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

        /* UI */
        #menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 5000; width: 45px; height: 45px; background: var(--accent); border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #menu-toggle span { width: 24px; height: 3px; background: #000; position: relative; }
        #menu-toggle span::before, #menu-toggle span::after { content:''; position:absolute; width:24px; height:3px; background:#000; left:0; }
        #menu-toggle span::before { top: -7px; } #menu-toggle span::after { top: 7px; }

        aside { position: fixed; top: 0; left: -350px; width: 320px; height: 100%; background: var(--panel); border-right: 2px solid var(--accent); transition: 0.4s; z-index: 4000; display: flex; flex-direction: column; }
        aside.open { left: 0; }
        .nav-tabs { display: flex; background: #000; }
        .nav-tabs button { flex: 1; padding: 15px; border: none; background: transparent; color: #555; font-weight: 900; cursor: pointer; }
        .nav-tabs button.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        .unit-card { background: #15151c; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #222; position: relative; }
        .status-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; float: right; }
        .loaded { background: #00ff8833; color: #00ff88; border: 1px solid #00ff8855; }

        /* LAYOUT PRINCIPAL */
        main { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; gap: 30px; padding: 20px; }
        #board { display: grid; grid-template-columns: repeat(8, 1fr); width: 82vmin; height: 82vmin; max-width: 550px; border: 4px solid #000; }
        .sq { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .l { background: var(--sq-l); } .d { background: var(--sq-d); }
        .piece { width: 85%; height: 85%; background-size: contain; background-repeat: no-repeat; background-position: center; }

        /* TORRE DE COMANDO */
        #command-deck { display: flex; flex-direction: column; gap: 20px; background: rgba(13,13,18,0.8); padding: 25px; border-radius: 20px; border: 1px solid #333; align-items: center; }
        .avatar-frame { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #444; background-size: cover; background-position: center; transition: 0.3s; }
        .turn-active-B { border-color: #fff !important; box-shadow: 0 0 20px #fff; transform: scale(1.1); }
        .turn-active-P { border-color: var(--danger) !important; box-shadow: 0 0 20px var(--danger); transform: scale(1.1); }
        .score-box { font-size: 28px; font-weight: 900; }

        /* MODAIS */
        .overlay { display: none; position: fixed; inset: 0; z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(15px); background: rgba(0,0,0,0.8); }
        .modal { background: var(--panel); padding: 30px; border-radius: 25px; border: 1px solid var(--accent); width: 320px; text-align: center; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-yes { background: var(--accent); color: #000; }
        .btn-atk { background: var(--danger); color: #fff; }
    </style>
</head>
<body>

<div id="menu-toggle" onclick="toggleMenu()"><span></span></div>

<aside id="sidebar">
    <div class="nav-tabs">
        <button id="tab-u" class="active" onclick="switchTab('u')">PE√áAS</button>
        <button id="tab-a" onclick="switchTab('a')">√ÅUDIO/MIXER</button>
    </div>
    <div style="display:flex; padding:10px; gap:10px; background:#111">
        <button onclick="changeTeam('B')" id="btn-B" style="flex:1; padding:8px; cursor:pointer; background:#333; color:#fff; border:1px solid #fff">BRANCAS</button>
        <button onclick="changeTeam('P')" id="btn-P" style="flex:1; padding:8px; cursor:pointer; background:#000; color:var(--danger); border:1px solid var(--danger)">PRETAS</button>
    </div>
    <div class="scroll-area">
        <div id="list-u">
            <div class="unit-card">
                <b id="avatar-title" style="color:#fff">AVATAR: COMANDANTE BRANCAS</b><br>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px">
                    <div id="side-preview" style="width:45px; height:45px; border-radius:50%; border:2px solid #555; background-size:cover; background-position:center; background-color:#000"></div>
                    <input type="file" onchange="upAvatar(this)" style="flex:1; font-size:10px">
                </div>
                <div id="hino-status" style="margin-top:10px; font-size:10px">Hino: <span>Aguardando...</span></div>
                <input type="file" onchange="upHino(this)" style="width:100%; font-size:10px; margin-top:5px">
            </div>
            <div id="pe√ßas-cont"></div>
        </div>
        <div id="list-a" style="display:none">
            <div class="unit-card">
                <b>MIXER VOLUME</b><br>
                BGM: <input type="range" id="v-m" min="0" max="1" step="0.1" value="0.5" oninput="vols()" style="width:100%">
                SFX: <input type="range" id="v-e" min="0" max="1" step="0.1" value="0.8" oninput="vols()" style="width:100%">
            </div>
            <div class="unit-card"><b>M√öSICA DE FUNDO</b><input type="file" onchange="upGlobal(this)" style="width:100%"></div>
        </div>
    </div>
    <button class="btn btn-yes" onclick="document.getElementById('m-starter').style.display='flex'">SALVAR E INICIAR</button>
</aside>

<main>
    <div id="board"></div>
    <div id="command-deck">
        <div class="commander-slot"><div id="mini-B" class="avatar-frame"></div><div id="s-b" class="score-box">0</div></div>
        <div style="font-weight:900; color:#333">VS</div>
        <div class="commander-slot"><div id="mini-P" class="avatar-frame" style="border-color: #500;"></div><div id="s-p" class="score-box" style="color:var(--danger)">0</div></div>
    </div>
</main>

<div id="m-victory" class="overlay"><div class="modal"><h1>PARAB√âNS!</h1><div id="win-photo" style="width:150px; height:150px; border-radius:50%; border:5px solid var(--accent); margin:20px auto; background-size:cover; background-position:center;"></div><h2 id="win-name"></h2><button class="btn btn-yes" onclick="resetGame()">REINICIAR</button></div></div>
<div id="m-starter" class="overlay"><div class="modal"><h2>QUEM COME√áA?</h2><button class="btn btn-yes" onclick="boot('B')">BRANCAS</button><button class="btn btn-atk" onclick="boot('P')">PRETAS</button></div></div>
<div id="m-ask-battle" class="overlay"><div class="modal"><h2 style="color:var(--danger)">CONFLITO!</h2><button class="btn btn-atk" onclick="startArena()">ARENA</button><button class="btn btn-no" onclick="cancelBattle()" style="background:#222; color:#fff">RECUAR</button></div></div>
<div id="m-confirm-move" class="overlay"><div class="modal"><h2>CONFIRMAR?</h2><button class="btn btn-yes" onclick="confirmMove(true)">SIM</button><button class="btn btn-no" onclick="confirmMove(false)" style="background:#222; color:#fff">CANCELAR</button></div></div>

<div id="arena" class="overlay" style="flex-direction:column">
    <h2 id="timer" style="font-size:60px; font-family:monospace">01:00</h2>
    <div style="display:flex; gap:20px; margin:30px 0">
        <div style="position:relative"><div id="a-img" style="width:140px; height:200px; border:3px solid var(--accent); background-size:contain; background-repeat:no-repeat; background-position:center; background-color:#111;"></div><button onclick="playSnd('atk')" style="position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); border-radius:50%; width:35px; height:35px; border:none; cursor:pointer">‚ñ∂</button></div>
        <div style="position:relative"><div id="d-img" style="width:140px; height:200px; border:3px solid var(--danger); background-size:contain; background-repeat:no-repeat; background-position:center; background-color:#111;"></div><button onclick="playSnd('def')" style="position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); border-radius:50%; width:35px; height:35px; border:none; cursor:pointer">‚ñ∂</button></div>
    </div>
    <button class="btn btn-yes" style="width:280px" onclick="finishDuel(true)">VIT√ìRIA</button>
    <button class="btn btn-atk" style="width:280px; background:#222" onclick="finishDuel(false)">RECUAR</button>
</div>

<script>
    let db, store = { p: {}, g: {killsB: 0, killsP: 0, avatarB: '', avatarP: '', hinoB: '', hinoP: '', bgm: ''} };
    const req = indexedDB.open("WarFinal_v28_9", 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore("assets");
    req.onsuccess = e => { db = e.target.result; loadData(); };

    let isLive = false, turn = 'B', sel = null, pending = null, currentTeam = 'B', timerInt, timeLeft = 60;
    const initialLayout = ['T1_P','C1_P','B1_P','Q1_P','K1_P','B2_P','C2_P','T2_P','P1_P','P2_P','P3_P','P4_P','P5_P','P6_P','P7_P','P8_P',...Array(32).fill(null),'P1_B','P2_B','P3_B','P4_B','P5_B','P6_B','P7_B','P8_B','T1_B','C1_B','B1_B','Q1_B','K1_B','B2_B','C2_B','T2_B'];
    let board = [...initialLayout];
    let audioMenu = new Audio(), audioAtk = new Audio(), audioDef = new Audio(), audioWin = new Audio();
    audioMenu.loop = true;

    function loadData() {
        db.transaction("assets").objectStore("assets").get("all").onsuccess = e => {
            if(e.target.result) store = e.target.result;
            if(store.g.bgm) audioMenu.src = store.g.bgm;
            updateUI(); changeTeam('B'); renderBoard();
        };
    }

    function changeTeam(t) {
        currentTeam = t;
        const label = document.getElementById('avatar-title'), preview = document.getElementById('side-preview'), hino = document.querySelector('#hino-status span');
        const btnB = document.getElementById('btn-B'), btnP = document.getElementById('btn-P');

        if(t === 'B') {
            label.innerText = "AVATAR: COMANDANTE BRANCAS"; label.style.color = "#fff";
            preview.style.backgroundImage = `url(${store.g.avatarB || ''})`;
            hino.innerText = store.g.hinoB ? "‚úÖ Carregado" : "Aguardando...";
            btnB.style.background = "#333"; btnP.style.background = "#000";
        } else {
            label.innerText = "AVATAR: COMANDANTE PRETAS"; label.style.color = "var(--danger)";
            preview.style.backgroundImage = `url(${store.g.avatarP || ''})`;
            hino.innerText = store.g.hinoP ? "‚úÖ Carregado" : "Aguardando...";
            btnP.style.background = "#333"; btnB.style.background = "#000";
        }
        renderList(); updateUI();
    }

    function renderList() {
        const container = document.getElementById('pe√ßas-cont'); container.innerHTML = '';
        const types = ['T1','C1','B1','Q1','K1','B2','C2','T2','P1','P2','P3','P4','P5','P6','P7','P8'];
        types.forEach(t => {
            const id = `${t}_${currentTeam}`;
            if(!store.p[id]) store.p[id] = { img: '', snd: '' };
            const hasImg = store.p[id].img !== '';
            const hasSnd = store.p[id].snd !== '';
            
            const d = document.createElement('div'); d.className = 'unit-card';
            d.innerHTML = `
                <span class="status-badge ${hasImg?'loaded':''}" style="margin-left:5px">${hasImg?'üñºÔ∏è OK':''}</span>
                <span class="status-badge ${hasSnd?'loaded':''}" style="margin-right:5px">${hasSnd?'üîä OK':''}</span>
                <b style="font-size:12px">${id}</b>
                <div style="display:flex; align-items:center; gap:8px; margin-top:8px">
                    <div style="width:30px; height:30px; background-image:url(${store.p[id].img}); background-size:cover; border:1px solid #444; border-radius:4px"></div>
                    <input type="file" onchange="upP('${id}','img',this)" style="font-size:9px; flex:1">
                </div>
                <input type="file" onchange="upP('${id}','snd',this)" style="font-size:9px; width:100%; margin-top:5px">
            `;
            container.appendChild(d);
        });
    }

    function upAvatar(i) {
        const r = new FileReader();
        r.onload = e => {
            if(currentTeam === 'B') store.g.avatarB = e.target.result; else store.g.avatarP = e.target.result;
            document.getElementById('side-preview').style.backgroundImage = `url(${e.target.result})`;
            save(); updateUI();
        };
        r.readAsDataURL(i.files[0]);
    }

    function upHino(i) { const r = new FileReader(); r.onload = e => { if(currentTeam === 'B') store.g.hinoB = e.target.result; else store.g.hinoP = e.target.result; save(); changeTeam(currentTeam); }; r.readAsDataURL(i.files[0]); }
    function upP(id, ty, i) { const r = new FileReader(); r.onload = e => { store.p[id][ty] = e.target.result; save(); renderList(); renderBoard(); }; r.readAsDataURL(i.files[0]); }
    function upGlobal(i) { const r = new FileReader(); r.onload = e => { store.g.bgm = e.target.result; audioMenu.src = e.target.result; save(); }; r.readAsDataURL(i.files[0]); }
    
    function updateUI() {
        document.getElementById('s-b').innerText = store.g.killsB; document.getElementById('s-p').innerText = store.g.killsP;
        document.getElementById('mini-B').style.backgroundImage = `url(${store.g.avatarB})`; document.getElementById('mini-P').style.backgroundImage = `url(${store.g.avatarP})`;
        document.getElementById('mini-B').className = 'avatar-frame' + (turn === 'B' && isLive ? ' turn-active-B' : '');
        document.getElementById('mini-P').className = 'avatar-frame' + (turn === 'P' && isLive ? ' turn-active-P' : '');
    }

    function renderBoard() {
        const b = document.getElementById('board'); b.innerHTML = '';
        board.forEach((id, i) => {
            const sq = document.createElement('div'); sq.className = `sq ${(Math.floor(i/8)+i%8)%2==0?'l':'d'}`;
            sq.onclick = () => handleSq(i);
            if(id) {
                const p = document.createElement('div'); p.className = 'piece';
                if(store.p[id]?.img) p.style.backgroundImage = `url(${store.p[id].img})`;
                else p.style.backgroundColor = id.endsWith('_B') ? '#fff' : '#f05';
                sq.appendChild(p);
            }
            b.appendChild(sq);
        });
    }

    function handleSq(i) {
        if(!isLive) return;
        if(sel === null) {
            if(board[i]?.endsWith('_'+turn)) { sel = i; renderBoard(); document.getElementById('board').children[i].style.boxShadow = "inset 0 0 20px var(--accent)"; }
        } else {
            if(board[i]?.endsWith('_'+turn)) { sel = i; renderBoard(); document.getElementById('board').children[i].style.boxShadow = "inset 0 0 20px var(--accent)"; }
            else if(board[i]) { pending = {f:sel, t:i}; document.getElementById('m-ask-battle').style.display = 'flex'; }
            else { pending = {f:sel, t:i}; document.getElementById('m-confirm-move').style.display = 'flex'; }
        }
    }

    function confirmMove(ok) { document.getElementById('m-confirm-move').style.display = 'none'; if(ok) { board[pending.t] = board[pending.f]; board[pending.f] = null; turn = turn === 'B' ? 'P' : 'B'; } sel = null; renderBoard(); updateUI(); }
    function finishDuel(win) { clearInterval(timerInt); document.getElementById('arena').style.display = 'none'; if(win) { if(turn === 'B') store.g.killsB++; else store.g.killsP++; board[pending.t] = board[pending.f]; board[pending.f] = null; turn = turn === 'B' ? 'P' : 'B'; save(); updateUI(); } sel = null; renderBoard(); checkVictory(); }
    function checkVictory() { const hasB = board.some(p => p?.endsWith('_B')), hasP = board.some(p => p?.endsWith('_P')); if(!hasB || !hasP) { const winner = hasB ? 'B' : 'P'; audioMenu.pause(); if(store.g['hino'+winner]) { audioWin.src = store.g['hino'+winner]; audioWin.play(); } document.getElementById('win-name').innerText = (winner==='B'?'BRANCAS':'PRETAS') + " VENCERAM!"; document.getElementById('win-photo').style.backgroundImage = `url(${store.g['avatar'+winner]})`; document.getElementById('m-victory').style.display = 'flex'; spawnConfetti(); isLive = false; } }
    function spawnConfetti() { for(let i=0; i<80; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = ['#00e5ff','#ff0055','#fff'][Math.floor(Math.random()*3)]; c.style.animationDuration = (Math.random() * 3 + 2) + 's'; c.style.top = '-10px'; document.body.appendChild(c); setTimeout(() => c.remove(), 5000); } }
    function startArena() { document.getElementById('m-ask-battle').style.display = 'none'; document.getElementById('a-img').style.backgroundImage = `url(${store.p[board[pending.f]]?.img || ''})`; document.getElementById('d-img').style.backgroundImage = `url(${store.p[board[pending.t]]?.img || ''})`; document.getElementById('arena').style.display = 'flex'; timeLeft = 60; timerInt = setInterval(() => { timeLeft--; document.getElementById('timer').innerText = `00:${timeLeft<10?'0'+timeLeft:timeLeft}`; if(timeLeft<=0) finishDuel(false); }, 1000); }
    function save() { db.transaction("assets","readwrite").objectStore("assets").put(store,"all"); }
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function switchTab(t) { document.getElementById('list-u').style.display = t==='u'?'block':'none'; document.getElementById('list-a').style.display = t==='a'?'block':'none'; document.getElementById('tab-u').className = t==='u'?'active':''; document.getElementById('tab-a').className = t==='a'?'active':''; }
    function boot(team) { isLive = true; turn = team; document.getElementById('m-starter').style.display='none'; if(audioMenu.src) audioMenu.play(); toggleMenu(); renderBoard(); updateUI(); }
    function resetGame() { board = [...initialLayout]; store.g.killsB = 0; store.g.killsP = 0; audioWin.pause(); save(); updateUI(); renderBoard(); document.getElementById('m-victory').style.display = 'none'; isLive = false; }
    function cancelBattle() { document.getElementById('m-ask-battle').style.display = 'none'; sel = null; renderBoard(); }
    function vols() { audioMenu.volume = document.getElementById('v-m').value; audioAtk.volume = audioDef.volume = audioWin.volume = document.getElementById('v-e').value; }
    function playSnd(role) { const id = role === 'atk' ? board[pending.f] : board[pending.t]; const p = role === 'atk' ? audioAtk : audioDef; if(store.p[id]?.snd) { p.src = store.p[id].snd; p.play(); } }
    renderBoard();
</script>
</body>
</html>