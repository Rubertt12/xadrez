<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>War Engine v33.2 - Battle Master</title>
    <style>
        :root { --bg: #050508; --panel: #0d0d12; --accent: #00e5ff; --danger: #ff0055; --sq-l: #1e1e24; --sq-d: #0a0a0f; --gold: #ffd700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body, html { 
            height: 100%; width: 100%; background: var(--bg); 
            font-family: 'Segoe UI', system-ui, sans-serif; color: white; 
            overflow: hidden; position: fixed; 
        }

        .app-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        @media (min-width: 1000px) { .app-container { flex-direction: row; } }

        /* DASHBOARD */
        #dashboard {
            background: rgba(13, 13, 18, 0.95); padding: 10px; display: flex; gap: 10px; z-index: 100;
            border-bottom: 1px solid #222; backdrop-filter: blur(10px);
        }
        @media (min-width: 1000px) {
            #dashboard { width: 300px; flex-direction: column; border-bottom: none; border-left: 1px solid #222; justify-content: center; padding: 20px; }
        }

        .player-card {
            flex: 1; display: flex; align-items: center; gap: 8px; 
            padding: 8px; border-radius: 8px; background: #000; border: 2px solid transparent; transition: 0.3s;
        }
        .active-B { border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .active-P { border-color: var(--danger); box-shadow: 0 0 15px rgba(255,0,85,0.2); }
        
        .p-img { width: 40px; height: 40px; border-radius: 6px; background-size: cover; background-position: center; background-color: #111; cursor: pointer; border: 1px solid #333; }
        .p-score { font-size: 18px; font-weight: 900; color: var(--accent); margin-left: auto; }

        /* BOARD */
        main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 5px; overflow: hidden; }
        .board-wrapper { position: relative; padding: 25px; background: #111; border-radius: 12px; border: 1px solid #222; }
        #board { display: grid; grid-template-columns: repeat(8, 1fr); width: min(88vw, 70vh); height: min(88vw, 70vh); border: 2px solid #333; }
        .sq { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .l { background: var(--sq-l); } .d { background: var(--sq-d); }
        .piece-container { width: 85%; height: 85%; position: relative; }
        .piece { width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; }

        /* OVERLAYS */
        .overlay { display: none; position: fixed; inset: 0; z-index: 9000; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .arena-content { width: 95%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        .arena-fighters { display: flex; justify-content: space-around; align-items: center; gap: 10px; }
        .arena-box { width: 100%; aspect-ratio: 3/4; background: #111; border: 2px solid #333; border-radius: 10px; background-size: cover; background-position: center; }

        /* VICTORY */
        .victory-content { text-align: center; animation: zoomIn 0.5s ease; }
        .trophy-wrap { position: relative; width: 160px; height: 160px; margin: 0 auto 20px; }
        .winner-photo-circle { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; background-size: cover; border: 3px solid var(--gold); }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* SIDEBAR */
        aside { position: fixed; top: 0; left: -310px; width: 300px; height: 100%; background: var(--panel); border-right: 2px solid var(--accent); transition: 0.3s; z-index: 8000; display: flex; flex-direction: column; }
        aside.open { left: 0; }
        #menu-toggle { position: fixed; bottom: 20px; right: 20px; z-index: 8500; width: 55px; height: 55px; background: var(--accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #000; font-size: 24px; cursor: pointer; }

        .tabs { display: flex; background: #000; }
        .tabs button { flex: 1; padding: 15px; background: none; border: none; color: #555; font-size: 11px; cursor: pointer; }
        .tabs button.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        .btn { width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .btn-yes { background: var(--accent); color: #000; }
        .unit-card { background: #1a1a24; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; font-size: 11px; }
    </style>
</head>
<body>

<div id="menu-toggle" onclick="toggleMenu()">‚ò∞</div>

<aside id="sidebar">
    <div style="padding: 20px; border-bottom: 1px solid #333;">
        <h2 style="color:var(--accent);">WAR ENGINE PRO</h2>
        <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px">
            <label style="font-size: 12px;"><input type="checkbox" id="edit-mode" onchange="renderBoard()"> MODO EDI√á√ÉO (REMOVER)</label>
            <label style="font-size: 12px; color: var(--accent); font-weight:bold;"><input type="checkbox" id="free-move"> MOVIMENTA√á√ÉO LIVRE</label>
        </div>
    </div>
    <div class="tabs">
        <button id="t-white" class="active" onclick="showTab('white')">BRANCAS</button>
        <button id="t-black" onclick="showTab('black')">PRETAS</button>
        <button id="t-sys" onclick="showTab('sys')">SISTEMA</button>
    </div>
    <div class="scroll-area" id="list-white"></div>
    <div class="scroll-area" id="list-black" style="display:none"></div>
    <div class="scroll-area" id="list-sys" style="display:none">
        <div class="unit-card">
            <b>VOLUME MESTRE</b>
            <input type="range" id="v-master" min="0" max="1" step="0.1" value="1" style="width:100%" oninput="updateMasterVolume()">
        </div>
        <div class="unit-card">
            <b style="color: var(--accent)">üé∂ √ÅUDIO AMBIENTE</b>
            <div id="ambient-controls" style="margin-top:10px; display: flex; flex-direction: column; gap: 12px;"></div>
        </div>
        <button class="btn" onclick="rollInitiative()" style="background:#222; color:var(--accent); margin-bottom: 8px; width: 100%">üé≤ SORTEAR IN√çCIO</button>
        <button class="btn" onclick="clearBoardPieces()" style="background:#333; color:#fff; margin-bottom: 8px; width: 100%">üßπ LIMPAR TABULEIRO</button>
        <button class="btn" onclick="resetGame()" style="background:var(--danger); color:#fff; width: 100%">‚ö†Ô∏è RESET TOTAL</button>
    </div>
    <div style="padding: 15px; background: #000;"><button class="btn btn-yes" style="width: 100%" onclick="startBattle()">ATIVAR BATALHA</button></div>
</aside>

<div class="app-container">
    <div id="dashboard">
        <div id="card-B" class="player-card">
            <div id="img-B" class="p-img" onclick="document.getElementById('f-av-B').click()"></div>
            <div id="score-B" class="p-score">0</div>
            <input type="file" id="f-av-B" style="display:none" onchange="upAvatar('B', this)">
        </div>
        <div id="card-P" class="player-card">
            <div id="img-P" class="p-img" onclick="document.getElementById('f-av-P').click()"></div>
            <div id="score-P" class="p-score" style="color:var(--danger)">0</div>
            <input type="file" id="f-av-P" style="display:none" onchange="upAvatar('P', this)">
        </div>
    </div>
    <main><div class="board-wrapper"><div id="board"></div></div></main>
</div>

<div id="arena" class="overlay">
    <div class="arena-content">
        <div class="arena-fighters">
            <div class="fighter" style="flex:1; text-align:center">
                <div id="a-img" class="arena-box" style="border-color: var(--accent)"></div>
                <div style="display:flex; gap:5px; margin-top:8px">
                    <button class="btn" onclick="audioAction('atk','play')" style="background:#004444; flex:1">‚ñ∂</button>
                    <button class="btn" onclick="audioAction('atk','pause')" style="background:#440000; flex:1">||</button>
                </div>
                <button class="btn btn-yes" onclick="finishDuel('atk')" style="margin-top:10px">VENCEU</button>
            </div>
            <div style="font-size: 24px;">‚öîÔ∏è</div>
            <div class="fighter" style="flex:1; text-align:center">
                <div id="d-img" class="arena-box" style="border-color: var(--danger)"></div>
                <div style="display:flex; gap:5px; margin-top:8px">
                    <button class="btn" onclick="audioAction('def','play')" style="background:#004444; flex:1">‚ñ∂</button>
                    <button class="btn" onclick="audioAction('def','pause')" style="background:#440000; flex:1">||</button>
                </div>
                <button class="btn" onclick="finishDuel('def')" style="background:var(--danger); color:#fff; margin-top:10px">VENCEU</button>
            </div>
        </div>
        <button class="btn" onclick="closeArena()" style="background:#222; margin-top:10px">CANCELAR DUELO</button>
    </div>
</div>

<div id="victory-modal" class="overlay">
    <div class="victory-content">
        <div class="trophy-wrap">
            <svg viewBox="0 0 24 24" fill="var(--gold)"><path d="M18,2H6V4H18V2M20,6V10C20,12.08 18.39,13.78 16.35,13.96C15.54,15.7 13.88,17 12,17C10.12,17 8.46,15.7 7.65,13.96C5.61,13.78 4,12.08 4,10V6H20M6,10H7.29C7.11,9.38 7,8.71 7,8H6V10M18,10V8H17C17,8.71 16.89,9.38 16.71,10H18M12,19A2,2 0 0,1 14,21H10A2,2 0 0,1 12,19Z" /></svg>
            <div id="victory-photo" class="winner-photo-circle"></div>
        </div>
        <h1 style="color:var(--gold); font-size: 28px;">CAMPE√ÉO!</h1>
        <p id="winner-name" style="margin: 10px 0 20px; font-weight: bold;"></p>
        <button class="btn btn-yes" onclick="location.reload()" style="width:200px">REINICIAR</button>
    </div>
</div>

<script>
    const peoes = ['P1','P2','P3','P4','P5','P6','P7','P8'];
    const nobres = ['T1','C1','B1','Q1','K1','B2','C2','T2'];
    const getInitialBoard = () => [
        ...nobres.map(id => id + '_P'), ...peoes.map(id => id + '_P'),
        ...Array(32).fill(null),
        ...peoes.map(id => id + '_B'), ...nobres.map(id => id + '_B')
    ];

    let db, store = { p: {}, g: {killsB:0, killsP:0, avatarB:'', avatarP:''}, board: getInitialBoard() };
    let ambientAudios = { Ambiente: new Audio(), Entrada: new Audio(), Intro1: new Audio(), Intro2: new Audio() };
    let audioAtk = new Audio(), audioDef = new Audio();
    let isLive = false, turn = 'B', sel = null, pending = null;
    let fadeInterval = null;

    const req = indexedDB.open("WarEngine_v33_2", 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore("assets");
    req.onsuccess = e => { db = e.target.result; loadData(); };

    function loadData() {
        db.transaction("assets").objectStore("assets").get("all").onsuccess = e => {
            if(e.target.result) store = e.target.result;
            if(!store.board) store.board = getInitialBoard();
            renderBoard(); updateUI(); renderConfigLists(); setupAmbientUI();
        };
    }

    function setupAmbientUI() {
        const cont = document.getElementById('ambient-controls'); cont.innerHTML = '';
        ['Ambiente', 'Entrada', 'Intro1', 'Intro2'].forEach(type => {
            if(store.g['snd'+type]) ambientAudios[type].src = store.g['snd'+type];
            ambientAudios[type].loop = (type === 'Ambiente');
            const div = document.createElement('div');
            div.style = "background: #000; padding: 8px; border-radius: 5px; border: 1px solid #333;";
            div.innerHTML = `<div style="font-size:10px; margin-bottom:5px; color:#aaa">${type.toUpperCase()}</div>
                <input type="file" style="font-size:10px; width:100%" onchange="upAmb('${type}', this)">
                <div style="display:flex; gap:5px; margin-top:5px">
                    <button class="btn" onclick="ambientAudios['${type}'].play()" style="flex:1; background:#004444">‚ñ∂</button>
                    <button class="btn" onclick="ambientAudios['${type}'].pause()" style="flex:1; background:#440000">||</button>
                </div>`;
            cont.appendChild(div);
        });
    }

    function fadeAmbient(targetVol, duration = 1000) {
        clearInterval(fadeInterval);
        const masterVol = parseFloat(document.getElementById('v-master').value);
        const finalTarget = targetVol * masterVol;
        const step = 0.05;
        const intervalTime = duration / (1 / step);
        fadeInterval = setInterval(() => {
            let allDone = true;
            Object.values(ambientAudios).forEach(audio => {
                if (!audio.paused) {
                    if (Math.abs(audio.volume - finalTarget) > step) {
                        audio.volume += (audio.volume < finalTarget) ? step : -step;
                        allDone = false;
                    } else { audio.volume = finalTarget; }
                }
            });
            if (allDone) clearInterval(fadeInterval);
        }, intervalTime);
    }

    function upAmb(t, i) {
        const r = new FileReader(); r.onload = e => { store.g['snd'+t] = e.target.result; ambientAudios[t].src = e.target.result; save(); };
        r.readAsDataURL(i.files[0]);
    }

    function updateMasterVolume() {
        const v = document.getElementById('v-master').value;
        Object.values(ambientAudios).forEach(a => a.volume = v);
        audioAtk.volume = v; audioDef.volume = v;
    }

    function renderBoard() {
        const b = document.getElementById('board'); b.innerHTML = '';
        const edit = document.getElementById('edit-mode').checked;
        store.board.forEach((id, i) => {
            const sq = document.createElement('div'); sq.className = `sq ${(Math.floor(i/8)+i%8)%2==0?'l':'d'}`;
            sq.onclick = () => handleSq(i);
            if(id) {
                const c = document.createElement('div'); c.className='piece-container';
                const p = document.createElement('div'); p.className='piece';
                if(store.p[id]?.img) p.style.backgroundImage = `url(${store.p[id].img})`;
                else p.style.backgroundColor = id.endsWith('_B') ? '#fff' : '#f05';
                c.appendChild(p);
                if(edit) {
                    const x = document.createElement('div'); x.innerHTML='√ó'; x.style="position:absolute;top:-5px;right:-5px;background:red;border-radius:50%;width:15px;height:15px;display:flex;justify-content:center;align-items:center;cursor:pointer;font-size:10px;border:1px solid white";
                    x.onclick=(e)=>{e.stopPropagation(); store.board[i]=null; renderBoard(); save();};
                    c.appendChild(x);
                }
                sq.appendChild(c);
            }
            b.appendChild(sq);
        });
    }

    function handleSq(i) {
        if(!isLive) return;
        const free = document.getElementById('free-move').checked;
        
        if(sel === null) {
            if(store.board[i] && (free || store.board[i].endsWith('_'+turn))) {
                sel = i; renderBoard(); document.getElementById('board').children[i].style.background = "#004444";
            }
        } else {
            // Se clicar na pr√≥pria pe√ßa (ou qualquer pe√ßa no modo livre), troca a sele√ß√£o
            // EXCETO se for clicar numa pe√ßa inimiga para atacar
            const clickingOwnColor = store.board[i] && store.board[i].endsWith(store.board[sel].slice(-2));
            
            if(store.board[i] && (free ? clickingOwnColor : store.board[i].endsWith('_'+turn))) {
                sel = i; renderBoard(); document.getElementById('board').children[i].style.background = "#004444";
            }
            // ATAQUE (Sempre funciona se clicar em cima de outra pe√ßa de cor diferente ou no modo livre)
            else if(store.board[i]) { pending = {f:sel, t:i}; openArena(); }
            // MOVIMENTO
            else { 
                store.board[i]=store.board[sel]; store.board[sel]=null; 
                if(!free) nextTurn(); else { sel=null; renderBoard(); save(); } 
            }
        }
    }

    function openArena() {
        const idA = store.board[pending.f], idD = store.board[pending.t];
        fadeAmbient(0.1);
        document.getElementById('a-img').style.backgroundImage = `url(${store.p[idA]?.img || ''})`;
        document.getElementById('d-img').style.backgroundImage = `url(${store.p[idD]?.img || ''})`;
        audioAtk.src = store.p[idA]?.snd || ""; audioDef.src = store.p[idD]?.snd || "";
        const master = document.getElementById('v-master').value;
        audioAtk.volume = (store.p[idA]?.vol ?? 0.7) * master;
        audioDef.volume = (store.p[idD]?.vol ?? 0.7) * master;
        document.getElementById('arena').style.display='flex';
    }

    function audioAction(role, act) { (role === 'atk' ? audioAtk : audioDef)[act](); }

    function finishDuel(w) {
        audioAtk.pause(); audioDef.pause();
        const free = document.getElementById('free-move').checked;
        if(w==='atk') {
            if(store.board[pending.f].endsWith('_B')) store.g.killsB++; else store.g.killsP++;
            store.board[pending.t]=store.board[pending.f]; store.board[pending.f]=null;
        } else {
            if(store.board[pending.t].endsWith('_B')) store.g.killsB++; else store.g.killsP++;
            store.board[pending.f]=null;
        }
        document.getElementById('arena').style.display='none';
        fadeAmbient(1); checkGameOver(); 
        if(!free) nextTurn(); else { sel=null; renderBoard(); save(); }
    }

    function clearBoardPieces() {
        if(confirm("Deseja remover todas as pe√ßas do tabuleiro para arrumar do zero?")) {
            store.board = Array(64).fill(null);
            renderBoard(); save();
        }
    }

    function checkGameOver() {
        const wb = store.board.filter(p => p?.endsWith('_B')).length;
        const pb = store.board.filter(p => p?.endsWith('_P')).length;
        if (wb === 0 || pb === 0) {
            isLive = false;
            const s = wb === 0 ? 'P' : 'B';
            document.getElementById('victory-photo').style.backgroundImage = `url(${store.g['avatar'+s]})`;
            document.getElementById('winner-name').innerText = `EX√âRCITO DAS ${wb===0?'PRETAS':'BRANCAS'}`;
            document.getElementById('victory-modal').style.display = 'flex';
        }
    }

    function renderConfigLists() {
        ['white','black'].forEach(s => {
            const team = s==='white'?'B':'P', cont = document.getElementById('list-'+s);
            cont.innerHTML = `<h3>${s.toUpperCase()}</h3>`;
            [...nobres, ...peoes].forEach(p => {
                const id = `${p}_${team}`; if(!store.p[id]) store.p[id] = {vol: 0.7};
                const d = document.createElement('div'); d.className = 'unit-card';
                d.innerHTML = `<b>${id}</b><br>IMG: <input type="file" onchange="upPiece('${id}','img',this)">
                SOM: <input type="file" onchange="upPiece('${id}','snd',this)">
                VOL: <input type="range" min="0" max="1" step="0.1" value="${store.p[id].vol}" oninput="store.p['${id}'].vol=parseFloat(this.value);save()">`;
                cont.appendChild(d);
            });
        });
    }

    function upPiece(id, t, i) {
        const r = new FileReader(); r.onload = e => { store.p[id][t] = e.target.result; save(); renderBoard(); };
        r.readAsDataURL(i.files[0]);
    }
    function upAvatar(s, i) {
        const r = new FileReader(); r.onload = e => { store.g['avatar'+s] = e.target.result; save(); updateUI(); };
        r.readAsDataURL(i.files[0]);
    }
    function showTab(t) {
        ['white','black','sys'].forEach(id => document.getElementById('list-'+id).style.display = (id===t?'block':'none'));
        ['t-white','t-black','t-sys'].forEach(id => document.getElementById(id).className = (id==='t-'+t?'active':''));
    }
    function nextTurn() { turn = turn==='B'?'P':'B'; sel=null; renderBoard(); updateUI(); save(); }
    function closeArena() { document.getElementById('arena').style.display='none'; audioAtk.pause(); audioDef.pause(); fadeAmbient(1); }
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function startBattle() { isLive=true; toggleMenu(); updateUI(); }
    function rollInitiative() { turn = Math.random() < 0.5 ? 'B' : 'P'; updateUI(); alert("Come√ßa: " + (turn==='B'?'BRANCO':'PRETO')); }
    function updateUI() {
        document.getElementById('score-B').innerText = store.g.killsB; document.getElementById('score-P').innerText = store.g.killsP;
        document.getElementById('img-B').style.backgroundImage = `url(${store.g.avatarB})`; document.getElementById('img-P').style.backgroundImage = `url(${store.g.avatarP})`;
        document.getElementById('card-B').className = 'player-card' + (turn==='B'&&isLive?' active-B':'');
        document.getElementById('card-P').className = 'player-card' + (turn==='P'&&isLive?' active-P':'');
    }
    function save() { db.transaction("assets","readwrite").objectStore("assets").put(store,"all"); }
    function resetGame() { if(confirm("‚ö†Ô∏è Reset total?")) { store = { p: {}, g: {killsB:0, killsP:0, avatarB:'', avatarP:''}, board: getInitialBoard() }; save(); location.reload(); } }
</script>
</body>
</html>