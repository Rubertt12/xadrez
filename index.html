<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>War Engine v7.0 - Ultra Adaptive</title>
    <style>
        :root { 
            --bg: #050505; --panel: #111115; --accent: #00e5ff; 
            --sq-l: #2a2a30; --sq-d: #15151a;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: sans-serif; overflow: hidden; color: white; }
        
        #app { display: flex; height: 100vh; width: 100vw; flex-direction: row; }

        /* Ajuste Mobile de Alta Performance */
        @media (max-width: 900px) {
            #app { flex-direction: column; }
            aside { 
                width: 100% !important; 
                height: 45vh !important; 
                border-left: none !important; 
                border-top: 2px solid var(--accent);
                position: relative;
                z-index: 100;
            }
            main { flex: 1; height: 55vh !important; }
            #board { 
                width: 85vw !important; 
                height: 85vw !important; 
                max-width: 40vh; /* Garante que não empurre o menu */
                max-height: 40vh;
            }
            .p-card { padding: 5px !important; }
            .p-card label { font-size: 7px !important; }
        }

        /* Sidebar com Scroll Interno */
        aside { 
            width: 380px; 
            background: var(--panel); 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }

        .tabs { display: flex; gap: 2px; position: sticky; top: 0; background: var(--panel); z-index: 10; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px 2px; font-size: 9px; background: #222; border: none; color: #777; cursor: pointer; border-radius: 3px; }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; }

        .tab-content { display: none; }
        .tab-content.active { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .p-card { background: #1a1a22; padding: 10px; border-radius: 5px; border-bottom: 2px solid #333; }
        .p-card label { font-size: 9px; color: var(--accent); display: block; margin-bottom: 4px; font-weight: bold; }
        input[type="file"] { font-size: 8px; width: 100%; color: #666; }

        /* Estética do Jogo */
        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #08080a; }
        
        #board { 
            display: grid; grid-template-columns: repeat(8, 1fr); 
            width: 70vh; height: 70vh; max-width: 500px; max-height: 500px; 
            border: 8px solid #000; outline: 1px solid #333;
        }

        .square { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .l { background: var(--sq-l); } .d { background: var(--sq-d); }
        .highlight { background: rgba(0, 229, 255, 0.3) !important; box-shadow: inset 0 0 10px var(--accent); }

        .piece { width: 85%; height: 85%; background-size: contain; background-repeat: no-repeat; background-position: center; transition: 0.2s; }

        .btn-start { 
            background: var(--accent); color: #000; border: none; 
            padding: 15px; font-weight: 900; cursor: pointer; width: 100%;
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        #turn-info { font-size: 11px; margin-top: 10px; letter-spacing: 2px; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <aside>
        <div class="scroll-area">
            <div class="tabs">
                <button class="tab-btn active" onclick="tab('w')">BASE W</button>
                <button class="tab-btn" onclick="tab('b')">BASE B</button>
                <button class="tab-btn" onclick="tab('s')">SISTEMA</button>
            </div>

            <div id="tab-w" class="tab-content active"></div>
            <div id="tab-b" class="tab-content"></div>
            <div id="tab-s" class="tab-content" style="grid-template-columns: 1fr;">
                <div class="p-card"><label>MÚSICA (BGM)</label><input type="file" onchange="sys('bgm', this)"></div>
                <div class="p-card"><label>VOLUME</label><input type="range" id="vol" min="0" max="1" step="0.1" value="0.5" style="width:100%"></div>
            </div>
        </div>
        <button class="btn-start" onclick="start()">INICIAR OPERAÇÃO</button>
    </aside>

    <main>
        <div id="board"></div>
        <div id="turn-info">SISTEMA: OFFLINE</div>
    </main>
</div>

<script>
    const dbName = "WarEngineV7";
    let db, store = { p: {}, g: {} };
    const req = indexedDB.open(dbName, 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore("data");
    req.onsuccess = e => { db = e.target.result; load(); };

    let active = false, turn = 'B', sel = null;
    let bgm = new Audio(); bgm.loop = true;

    const layout = [
        'T1_P','C1_P','B1_P','Q_P','K_P','B2_P','C2_P','T2_P',
        'P1_P','P2_P','P3_P','P4_P','P5_P','P6_P','P7_P','P8_P',
        ...Array(32).fill(null),
        'P1_B','P2_B','P3_B','P4_B','P5_B','P6_B','P7_B','P8_B',
        'T1_B','C1_B','B1_B','Q_B','K_B','B2_B','C2_B','T2_B'
    ];
    let board = [...layout];

    function load() {
        db.transaction("data").objectStore("data").get("assets").onsuccess = e => {
            if(e.target.result) {
                store = e.target.result;
                if(store.g.bgm) bgm.src = store.g.bgm;
            }
            initUI();
        };
    }

    function initUI() {
        layout.forEach(id => {
            if(!id) return;
            const container = document.getElementById(id.endsWith('_B') ? 'tab-w' : 'tab-b');
            if(!store.p[id]) store.p[id] = { img: '' };
            const card = document.createElement('div');
            card.className = 'p-card';
            card.innerHTML = `<label>${id}</label><input type="file" onchange="up('${id}', this)">`;
            container.appendChild(card);
        });
        render();
    }

    function up(id, input) {
        const reader = new FileReader();
        reader.onload = e => {
            store.p[id].img = e.target.result;
            db.transaction("data", "readwrite").objectStore("data").put(store, "assets");
            render();
        };
        reader.readAsDataURL(input.files[0]);
    }

    function sys(type, input) {
        const reader = new FileReader();
        reader.onload = e => {
            store.g[type] = e.target.result;
            db.transaction("data", "readwrite").objectStore("data").put(store, "assets");
            if(type === 'bgm') { bgm.src = e.target.result; bgm.play(); }
        };
        reader.readAsDataURL(input.files[0]);
    }

    function render() {
        const b = document.getElementById('board');
        b.innerHTML = '';
        board.forEach((id, i) => {
            const sq = document.createElement('div');
            sq.className = `square ${(Math.floor(i/8)+i%8)%2==0?'l':'d'}`;
            sq.onclick = () => click(i);
            if(id) {
                const p = document.createElement('div');
                p.className = 'piece';
                if(store.p[id]?.img) p.style.backgroundImage = `url(${store.p[id].img})`;
                else p.style.backgroundColor = id.endsWith('_B') ? '#fff' : '#ff0055';
                sq.appendChild(p);
            }
            b.appendChild(sq);
        });
    }

    function click(i) {
        if(!active) return;
        const p = board[i];
        if(sel === null) {
            if(p && p.endsWith('_' + turn)) { sel = i; render(); document.getElementById('board').children[i].classList.add('highlight'); }
        } else {
            if(p && p.endsWith('_' + turn)) { sel = i; render(); document.getElementById('board').children[i].classList.add('highlight'); }
            else {
                board[i] = board[sel]; board[sel] = null;
                turn = turn === 'B' ? 'P' : 'B';
                sel = null; render();
                document.getElementById('turn-info').innerText = "TURNO: " + (turn === 'B' ? 'BRANCO' : 'PRETO');
            }
        }
    }

    function start() { active = true; if(bgm.src) bgm.play(); document.getElementById('turn-info').innerText = "SISTEMA ONLINE - TURNO: BRANCO"; }
    function tab(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        event.currentTarget.classList.add('active');
    }
    document.getElementById('vol').oninput = e => bgm.volume = e.target.value;
</script>
</body>
</html>