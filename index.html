<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>War Engine v6.1 - Mobile Fix</title>
    <style>
        :root { 
            --bg: #08080a; --panel: #121216; --accent: #00e5ff; --accent-glow: rgba(0, 229, 255, 0.4);
            --sq-l: #2c2c34; --sq-d: #1a1a1f;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: system-ui, -apple-system, sans-serif; overflow: hidden; color: white; }
        #app { display: flex; height: 100vh; width: 100vw; flex-direction: row; }

        /* AJUSTE MOBILE CRÍTICO */
        @media (max-width: 900px) {
            #app { flex-direction: column; }
            aside { 
                width: 100% !important; 
                height: 40% !important; 
                order: 2; 
                padding: 10px !important;
                border-top: 2px solid var(--accent);
            }
            main { height: 60% !important; order: 1; overflow: hidden; }
            #board { width: 85vw !important; height: 85vw !important; max-width: 350px; max-height: 350px; }
            .btn-action-main { position: sticky; bottom: 0; left: 0; z-index: 100; margin-top: 0 !important; }
        }

        aside { 
            width: 380px; 
            background: var(--panel); 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #333; 
            box-sizing: border-box;
            overflow: hidden;
        }

        .menu-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }

        .logo-header { text-align: center; font-weight: 900; color: var(--accent); margin-bottom: 15px; font-size: 14px; }
        
        #war-log { background: #000; border: 1px solid #222; margin: 10px 0; padding: 10px; font-family: monospace; font-size: 10px; color: #00ff41; height: 80px; overflow-y: auto; }

        .tabs { display: flex; gap: 2px; position: sticky; top: 0; background: var(--panel); z-index: 5; padding-bottom: 5px; }
        .tab-btn { flex: 1; padding: 12px 5px; font-size: 9px; background: #222; border: 1px solid #333; color: #888; cursor: pointer; }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .p-card { background: #1a1a20; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid var(--accent); }
        .p-card label { font-size: 9px; color: #aaa; display: block; margin-bottom: 4px; }
        input[type="file"] { font-size: 10px; width: 100%; }

        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        
        #board { 
            display: grid; grid-template-columns: repeat(8, 1fr); 
            width: 70vh; height: 70vh; max-width: 500px; max-height: 500px; 
            border: 5px solid #111; 
        }

        .square { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .l { background: var(--sq-l); } .d { background: var(--sq-d); }
        .selected { background: rgba(0, 229, 255, 0.4) !important; }

        .piece { width: 90%; height: 90%; background-size: contain; background-repeat: no-repeat; background-position: center; }

        .btn-action-main { 
            background: var(--accent); 
            color: #000; 
            border: none; 
            padding: 18px; 
            font-weight: 900; 
            cursor: pointer; 
            width: 100%; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        
        #victory-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="victory-overlay">
    <h1 id="win-msg" style="color:var(--accent)">VITÓRIA</h1>
    <button class="btn-action-main" style="width: 200px" onclick="location.reload()">REINICIAR</button>
</div>

<div id="app">
    <aside>
        <div class="menu-content">
            <div class="logo-header">WAR ENGINE v6.1</div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('tab-w')">TIME W</button>
                <button class="tab-btn" onclick="switchTab('tab-b')">TIME B</button>
                <button class="tab-btn" onclick="switchTab('tab-config')">SISTEMA</button>
            </div>

            <div id="tab-w" class="tab-content active"></div>
            <div id="tab-b" class="tab-content"></div>
            <div id="tab-config" class="tab-content">
                <div class="p-card"><label>MÚSICA</label><input type="file" onchange="storeGlobal('bgm', this)"></div>
                <div class="p-card"><label>VOLUME</label><input type="range" id="vol-control" min="0" max="1" step="0.1" value="0.5" style="width:100%"></div>
                <button onclick="clearAllData()" style="width:100%; font-size:10px; background:red; color:white; border:none; padding:10px; margin-top:10px">RESETAR TUDO</button>
            </div>

            <div id="war-log"></div>
        </div>
        <button class="btn-action-main" onclick="initGameEngine()">ATIVAR SISTEMA</button>
    </aside>

    <main>
        <div id="board"></div>
        <div id="status-turn" style="font-size: 10px; margin-top: 10px; color: var(--accent);">TURNO: BRANCO</div>
    </main>
</div>

<script>
    // Gerenciador de Banco de Dados
    const DB_NAME = "WarChessMobileDB";
    let db, storage = { pieces: {}, global: {} };
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("assets");
    request.onsuccess = e => { db = e.target.result; loadSavedAssets(); };

    let engineActive = false, currentTurn = 'B', selectedCell = null;
    let bgmPlayer = new Audio(); bgmPlayer.loop = true;

    const layout = [
        'T1_P','C1_P','B1_P','Q_P','K_P','B2_P','C2_P','T2_P',
        'P1_P','P2_P','P3_P','P4_P','P5_P','P6_P','P7_P','P8_P',
        ...Array(32).fill(null),
        'P1_B','P2_B','P3_B','P4_B','P5_B','P6_B','P7_B','P8_B',
        'T1_B','C1_B','B1_B','Q_B','K_B','B2_B','C2_B','T2_B'
    ];
    let boardState = [...layout];

    function loadSavedAssets() {
        db.transaction("assets", "readonly").objectStore("assets").get("data").onsuccess = e => {
            if(e.target.result) {
                storage = e.target.result;
                if(storage.global.bgm) bgmPlayer.src = storage.global.bgm;
            }
            buildUI();
        };
    }

    function buildUI() {
        layout.forEach(id => {
            if(!id) return;
            const tab = document.getElementById(id.endsWith('_B') ? 'tab-w' : 'tab-b');
            if(!storage.pieces[id]) storage.pieces[id] = { img: '' };
            const card = document.createElement('div');
            card.className = 'p-card';
            card.innerHTML = `<label>${id}</label><input type="file" onchange="saveAsset('${id}', this)">`;
            tab.appendChild(card);
        });
        drawBoard();
    }

    function saveAsset(id, input) {
        const reader = new FileReader();
        reader.onload = e => {
            storage.pieces[id].img = e.target.result;
            db.transaction("assets", "readwrite").objectStore("assets").put(storage, "data");
            drawBoard();
        };
        reader.readAsDataURL(input.files[0]);
    }

    function storeGlobal(type, input) {
        const reader = new FileReader();
        reader.onload = e => {
            storage.global[type] = e.target.result;
            db.transaction("assets", "readwrite").objectStore("assets").put(storage, "data");
            if(type==='bgm') { bgmPlayer.src = e.target.result; bgmPlayer.play(); }
        };
        reader.readAsDataURL(input.files[0]);
    }

    function drawBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        boardState.forEach((id, i) => {
            const sq = document.createElement('div');
            sq.className = `square ${(Math.floor(i/8)+i%8)%2==0?'l':'d'}`;
            sq.onclick = () => onCellClick(i);
            if(id) {
                const p = document.createElement('div');
                p.className = 'piece';
                if(storage.pieces[id]?.img) p.style.backgroundImage = `url(${storage.pieces[id].img})`;
                else p.style.backgroundColor = id.endsWith('_B') ? '#fff' : '#ff0055';
                sq.appendChild(p);
            }
            board.appendChild(sq);
        });
    }

    function onCellClick(i) {
        if(!engineActive) return;
        const piece = boardState[i];
        if(selectedCell === null) {
            if(piece && piece.endsWith('_' + currentTurn)) {
                selectedCell = i;
                drawBoard();
                document.getElementById('board').children[i].classList.add('selected');
            }
        } else {
            if(piece && piece.endsWith('_' + currentTurn)) {
                selectedCell = i;
                drawBoard();
                document.getElementById('board').children[i].classList.add('selected');
            } else {
                boardState[i] = boardState[selectedCell];
                boardState[selectedCell] = null;
                currentTurn = currentTurn === 'B' ? 'P' : 'B';
                selectedCell = null;
                drawBoard();
                document.getElementById('status-turn').innerText = "TURNO: " + (currentTurn==='B'?'BRANCO':'PRETO');
            }
        }
    }

    function initGameEngine() { engineActive = true; if(bgmPlayer.src) bgmPlayer.play(); alert("SISTEMA ATIVADO!"); }
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }
    document.getElementById('vol-control').oninput = e => bgmPlayer.volume = e.target.value;
    function clearAllData() { if(confirm("Apagar tudo?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } }
</script>
</body>
</html>